@{
    Layout = "";
}

@using DataModels
@using DataModels.Questions
@using WBK.Models.Create
@model WBK.Models.Create.SurveyViewModel

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WijkBeweegKaart</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

    <script src="~/lib/jquery/dist/jquery.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.css" />
    <link rel="stylesheet" href="~/css/site.css" />
</head>

<body class="p-0">
    <nav class="navbar navbar-light" style="background-color: #F9A11B;">
        <a class="navbar-brand" href="#">
            <img src="~/images/WijkBeweegKaart Logo.png" alt="WijkBeweegKaart" style="height: 80px; width: 360px;" />
        </a>
    </nav>
    <div class="container-fluid">
        <div class="">
            <h1>Enquête Aanmaken:</h1>
            @using (Html.BeginForm("Survey", "Create", FormMethod.Post, new { @class = "row" }))
            {
                @Html.AntiForgeryToken()

                <div class="col-6 form-group" style="margin-top: 20px;">
                    <div>
                        <label>Titel:</label>
                        @Html.TextBoxFor(x => x.Title, new { required = "required", @class="form-control" })
                    </div>
                    <div>
                        <label>Beschrijving:</label>
                        @Html.TextAreaFor(x => x.Description, new { rows = "10", cols = "80", @class = "form-control" })
                    </div>
                    <div>
                        <label>Eind Datum:</label>
                        <div class="input-group date" data-provide="datepicker">
                            @Html.TextBoxFor(model => model.EndDate, new { required = "required", @class = "form-control" })
                            <div class="input-group-addon">
                                <span class="glyphicon glyphicon-th"></span>
                            </div>
                        </div>
                    </div>

                    <div style="z-index: 1; position: relative;">
                        <label>Selecteer locatie:</label>
                        <div id="mapid" style="height: 400px; width: 400px;" class=""></div>
                        <p>Klik op de kaart om de waardes in te voeren!</p>
                        <label>Latitude:</label>
                        @Html.TextBoxFor(x => x.StartLocationLat, new { required = "required", @class = "form-control" })
                        <label>Longitude:</label>
                        @Html.TextBoxFor(x => x.StartLocationLong, new { required = "required", @class = "form-control" })
                    </div>

                    <input type="submit" name="name" value="Maak Aan!" class="btn btn-success" />

                </div>

                <div class="col-6 form-group">
                    <h2>Pagina's en vragen:</h2>
                    <div id="InputsWrapper">
                        @for (var i = 0; i < Model.PagesList.Count(); i++)
                        {
                            <div class="pageDiv">
                                <h3>Pagina @i</h3>
                                @Html.TextBoxFor(x => x.PagesList[i].Title, new { placeholder = "Pagina Titel", required = "required", @class = "form-control" })
                                @Html.ValidationMessageFor(x => x.PagesList[i].Title)

                                @Html.TextAreaFor(x => x.PagesList[i].Description, new { placeholder = "Pagina Beschrijving", rows = "5", cols = "40", @class = "form-control" })
                                @Html.ValidationMessageFor(x => x.PagesList[i].Description)

                                @Html.Label("PageCounter", i.ToString(), new { style = "display: none;" })     

                                <div class="QuestionWrapper">

                                    @for (var j = 0; j < Model.PagesList[i].Questions.Count(); j++)
                                    {
                                    <div class="questionDiv">
                                        <h3>Vraag @j</h3>

                                        @Html.TextBoxFor(x => x.PagesList[i].Questions[j].Title, new { placeholder = "Vraag", required = "required", @class = "form-control" })
                                        @Html.TextBoxFor(x => x.PagesList[i].Questions[j].Description, new { placeholder = "Vraag Beschrijving", required = "required", @class = "form-control" })
                                        @Html.DropDownListFor(x => x.PagesList[i].Questions[j].Type, Html.GetEnumSelectList(Model.PagesList[i].Questions[j].Type.GetType()), new { @class = "form-control" })
                                        @Html.DropDownListFor(x => x.PagesList[i].Questions[j].Category, Html.GetEnumSelectList(Model.PagesList[i].Questions[j].Category.GetType()), new { @class = "form-control" })

                                        @Html.Label("QuestionCounter", j.ToString(), new { style = "display: none;" })

                                        <div class="question">
                                            @switch (Model.PagesList[i].Questions[j].Type)
                                            {
                                                case TypeEnum.GeoVraag:
                                                    <label>Marker Type:</label>
                                                    @Html.DropDownListFor(x => x.PagesList[i].Questions[j].GeoType, Html.GetEnumSelectList(Model.PagesList[i].Questions[j].GeoType.GetType()), new { @class = "form-control" })
                                                    break;
                                                case TypeEnum.SliderVraag:
                                                    <label>Tekst aan begin slider:</label>
                                                    @Html.TextBoxFor(x => x.PagesList[i].Questions[j].SliderMinText, new { @class = "form-control" });
                                                    <label>Tekst aan eind slider:</label>
                                                    @Html.TextBoxFor(x => x.PagesList[i].Questions[j].SliderMaxText, new { @class = "form-control" });
                                                    <label>Max waarde:</label>
                                                    @Html.EditorFor(x => x.PagesList[i].Questions[j].SliderScaleVal, new { @class = "form-control" });
                                                    <p>(De begin waarde is altijd 0. Het getal dat hierboven ingevuld wordt is de maximale waarde.)</p>
                                                    break;
                                                case TypeEnum.NummerVraag:
                                                    <label>Minimum waarde</label>
                                                    @Html.EditorFor(x => x.PagesList[i].Questions[j].MinValue, new { @class = "form-control" });
                                                    <label>Maximum waarde</label>
                                                    @Html.EditorFor(x => x.PagesList[i].Questions[j].MaxValue, new { @class = "form-control" });
                                                    break;
                                                case TypeEnum.MeerkeuzeVraag:
                                                    @Html.CheckBoxFor(x => x.PagesList[i].Questions[j].AllowMultipleAnswers, new { @class = "form-check" });

                                                    for (int q = 0; q < Model.PagesList[i].Questions[j].Options.Count; q++)
                                                    {
                                                        <label>Antwoord:</label>
                                                        <input class="form-control" id="PagesList_@i+__Questions_@j+__Options_@q+__Answer" name="PagesList[@i+].Questions[@j+].Options[@q+].Answer" type="text" value="@Model.PagesList[i].Questions[j].Options[q].Answer" />
                                                        <label>Eventuele beschrijving:</label>
                                                        <input class="form-control" id="PagesList_@i+__Questions_@j+__Options_@q+__Description" name="PagesList[@i+].Questions[@j+].Options[@q+].Description" type="text" value="@Model.PagesList[i].Questions[j].Options[q].Description" />
                                                    }
                                                    break;
                                            }
                                        </div>
                                        <a href="" class="removeQuestionClass btn btn-danger">Vraag verwijderen</a>
                                    </div>

                                    }

                                </div>

                                <div class="addQuestion">
                                    <a href="" class="addQuestionButton btn btn-info">Voeg Vraag Toe</a>
                                </div>

                                <div class="preMadeQuestions">
                                    <button href="" class="addProfileQuestionButton btn btn-info">Voeg Profiel Vragen Toe</button>
                                    <button href="" class="addNNGBQuestionButton btn btn-info">Voeg NNGB vragen Toe</button>
                                    <button href="" class="addMotivationQuestionButton btn btn-info">Voeg Motivatie vragen Toe</button>
                                </div>

                                <a href="" class="removeclass btn btn-danger">Pagina verwijderen</a>
                            </div>

                        }
                    </div>

                    <div id="AddMoreFileId">
                        <a href="" id="AddMoreFileBox" class="btn btn-info">Voeg Pagina Toe</a><br><br>
                    </div>

                </div>

            }

        </div>

    </div>

    <script type="text/javascript">

    var mymap = L.map('mapid').setView([51.47358, 5.453167], 13);
    var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);
    var marker = L.marker();

    function onMapClick(e) {
        marker
            .setLatLng(e.latlng)
            .bindPopup("You clicked the map at " + e.latlng.toString())
            .addTo(mymap);
        document.getElementsByName("StartLocationLat")[0].value = e.latlng.lat;
        document.getElementsByName("StartLocationLong")[0].value = e.latlng.lng;
    }
    mymap.on('click', onMapClick);

    $(document).ready(function () {
        console.log("ready!");


        $('#EndDate').datepicker({ minDate: -0 });


        function appendToDiv(parentDiv, url, pageNumber, questionNumber) {
            url = url.replace("x", pageNumber);
            url = url.replace("y", questionNumber);
            url = url.replace(/&amp;/g, '&');
            console.log(url);
            console.log($(parentDiv));
            $.ajax({
                type: "GET",
                url: url,
                success: function (text) {
                    $(parentDiv).append(text);
                }
            });
        }

        $("body").on("change",
            "select",
            function (e) {
                console.log($(this).parent().children('.question'));
                if (this.id.includes("Type")) {
                    var parentDiv = $(this).parent();
                    parentDiv.children('.question').empty();
                    var str = this.id;
                    var indexOfPage = str.indexOf("t_");
                    var indexOfQeustions = str.indexOf("s_");
                    var pageNumber = str.charAt(indexOfPage + 2);
                    var questionNumber = str.charAt(indexOfQeustions + 2);
                    var url = "";
                    switch (parseInt(this.value)) {
                    case 0:
                            url = '@Url.Action("GeoQuestion","Create", new { pageId = 'x', questionId = 'y'})';
                            appendToDiv(parentDiv.children('.question'), url, pageNumber, questionNumber);
                        break;
                    case 1:
                            url = '@Url.Action("MultipleChoiceQuestion","Create", new { pageId = 'x', questionId = 'y'})';
                            appendToDiv(parentDiv.children('.question'), url, pageNumber, questionNumber);
                        break;
                    case 3:
                            url = '@Url.Action("SliderQuestion","Create", new { pageId = 'x', questionId = 'y'})';
                            appendToDiv(parentDiv.children('.question'), url, pageNumber, questionNumber);
                        break;
                    case 4:
                            url = '@Url.Action("NumberQuestion","Create", new { pageId = 'x', questionId = 'y'})';
                            appendToDiv(parentDiv.children('.question'), url, pageNumber, questionNumber);
                        break;
                    }

                }
            });


        var profileQuestionsUsed = false;
        var nngbQuestionsUsed = false;
        var motivationQuestionsUsed = false;


        //Pagina
        var MaxInputsPage = 10;
        var InputsWrapper = $("#InputsWrapper");
        var AddButtonPage = $("#AddMoreFileBox");
        var x = InputsWrapper.length;
        $(AddButtonPage).click(function (e) {
            e.preventDefault();
            var currentPageCount = $('.pageDiv').length;
            if (x <= MaxInputsPage) {
                var url = '@Url.Action("PageView","Create", new { pageId = 'x'})';
                url = url.replace("x", currentPageCount);
                url = url.replace(/&amp;/g, '&');
                $.ajax({ type: "GET",
                    url: url ,
                    success: function (text) {

                        if (profileQuestionsUsed) {
                            text = $(text).find('.addProfileQuestionButton').remove().end();
                        }

                        if (nngbQuestionsUsed) {
                            text = $(text).find('.addNNGBQuestionButton').remove().end();
                        }

                       if (motivationQuestionsUsed) {
                            text = $(text).find('.addMotivationQuestionButton').remove().end();
                        }

                        $(InputsWrapper).append(text);
                    }
                });


                x++;
                $("#AddMoreFileId").show();
                $('AddMoreFileBox').html("Add field");
                if (x == MaxInputsPage) {
                    $("#AddMoreFileId").hide();
                }
            }
            return false;
        });

        $("body").on("click", ".addProfileQuestionButton", function(e) {
            e.preventDefault();
            var pageNumber = $(this).parent().parent().children("label")[0].innerHTML;
            var questionWrapper = $(this).parent().parent().children(".QuestionWrapper");
            var currentQuestionCount = $(questionWrapper).children(".questionDiv").length;
            var url = '@Url.Action("ProfileQuestions","Create", new { pageId = 'x', questionId = 'y'})';
            appendToDiv(questionWrapper, url, pageNumber, currentQuestionCount);
            profileQuestionsUsed = true;
            $(".addProfileQuestionButton").hide();
        });

        $("body").on("click", ".addNNGBQuestionButton", function(e) {
            e.preventDefault();
            var pageNumber = $(this).parent().parent().children("label")[0].innerHTML;
            var questionWrapper = $(this).parent().parent().children(".QuestionWrapper");
            var currentQuestionCount = $(questionWrapper).children(".questionDiv").length;
            var url = '@Url.Action("NngbQuestions","Create", new { pageId = 'x', questionId = 'y'})';
            appendToDiv(questionWrapper, url, pageNumber, currentQuestionCount);
            nngbQuestionsUsed = true;
            $(".addNNGBQuestionButton").hide();
        });

        $("body").on("click", ".addMotivationQuestionButton", function(e) {
            e.preventDefault();
            var pageNumber = $(this).parent().parent().children("label")[0].innerHTML;
            var questionWrapper = $(this).parent().parent().children(".QuestionWrapper");
            var currentQuestionCount = $(questionWrapper).children(".questionDiv").length;
            var url = '@Url.Action("MotivationQuestions","Create", new { pageId = 'x', questionId = 'y'})';
            appendToDiv(questionWrapper, url, pageNumber, currentQuestionCount);
            motivationQuestionsUsed = true;
            $(".addMotivationQuestionButton").hide();
        });

        $("body").on("click",
            ".removeclass",
            function (e) {
                e.preventDefault();
                if (x > 1) {
                    $(this).parent('div').remove(); //remove text box
                    x--; //decrement textbox
                    var i;
                    var pages = $('.pageDiv').toArray();
                    var counters = $('.pageDiv label[for=PageCounter]').toArray();
                    for (i = 0; i < pages.length; i++) {
                        var children = pages[i].children;
                        for (j = 0; j < children.length; j++) {
                            var child = children[j];
                            switch (child.tagName) {
                            case "H3":
                                child.innerHTML = "Pagina " + i;
                                break;
                            case "INPUT":
                                child.id = child.id.replace("PagesList_" + counters[i].innerHTML, "PagesList_" + i);
                                child.name = child.name.replace("PagesList[" + counters[i].innerHTML + "]",
                                    "PagesList[" + i + "]");
                                break;
                            case "LABEL":
                                child.innerHTML = i;
                                break;
                            default:
                            }
                        }
                    };
                    $("#AddMoreFileId").show();
                    // Adds the "add" link again when a field is removed.
                    $('AddMoreFileBox').html("Add field");
                }
                return false;
            });

        $("body").on("click",".addQuestionButton",function (e) {
                e.stopPropagation();
                e.stopImmediatePropagation();
                e.preventDefault();
                var pageNumber = $(this).parent().parent().parent().children().length -1;
                var questionWrapper = $(this).parent().parent().children(".QuestionWrapper");
                var currentQuestionCount = $(questionWrapper).children(".questionDiv").length;
            var url = '/Create/QuestionView?pageId=x&questionId=y';
            console.log(url);
                url = url.replace("x", pageNumber);
                url = url.replace("y", currentQuestionCount);
                console.log(questionWrapper);
                console.log(url);
                $.ajax({ type: "GET",
                    url: url ,
                    success : function(text)
                    {
                        $(questionWrapper).append(text);
                    }
                });
            });

        $("body").on("click",
            ".removeQuestionClass",
            function (e) {
                e.preventDefault();
                var questionsWrapper = $(this).parent().parent();
                var i;
                var j;
                var q;
                if (questionsWrapper.children().length > 1) {
                    $(this).parent('div').remove();
                    var questions = questionsWrapper.children();
                    console.log(questions);
                    for (q = 0; q < questions.length; q++) {
                        var children = questions[q].children;
                        var oldNumber = children[5].innerHTML;
                        for (j = 0; j < children.length; j++) {
                            var child = children[j];
                            switch (child.tagName) {
                            case "H3":
                                child.innerHTML = "Vraag " + q;
                                break;
                            case "INPUT":
                                child.id = child.id.replace("Questions_" + oldNumber, "Questions_" + q);
                                child.name = child.name.replace("Questions[" + oldNumber + "]", "Questions[" + q + "]");
                                break;
                            case "SELECT":
                                child.id = child.id.replace("Questions_" + oldNumber, "Questions_" + q);
                                child.name = child.name.replace("Questions[" + oldNumber + "]", "Questions[" + q + "]");
                                break;
                            case "LABEL":
                                child.innerHTML = q;
                                break;
                            default:
                            }
                        }
                    }
                }
                return false;
            });

        $("body").on("click",
            ".addMCOption",
            function (e) {
                e.preventDefault();
                var wrapper = $(this).parent().parent().children()[0];
                var numberOfOptions = $(wrapper).children(".MCOption").length;
                var pageNumber = $(this).parent().parent().parent().parent().parent().children("label")[0].innerHTML;
                var questionWrapper = $(this).parent().parent().parent().parent().parent().children(".QuestionWrapper");
                var currentQuestionCount = $(questionWrapper).children(".questionDiv").length - 1;
                console.log(wrapper);
                console.log(currentQuestionCount);
                $(wrapper).append(
                    '<div class="MCOption">' +
                    '<label>Antwoord:</label> <input id="PagesList_' + pageNumber + '__Questions_' + currentQuestionCount + '__Options_' + numberOfOptions + '__Answer" name="PagesList[' + pageNumber + '].Questions[' +
                    currentQuestionCount +
                    '].Options[' +
                    numberOfOptions +
                    '].Answer" type="text" value="" />' +
                    '<label>Eventuele beschrijving:</label> <input id="PagesList_' +
                    pageNumber +
                    '__Questions_' +
                    currentQuestionCount +
                    '__Options_' +
                    numberOfOptions +
                    '__Description" name="PagesList[' +
                    pageNumber +
                    '].Questions[' +
                    currentQuestionCount +
                    '].Options[' +
                    numberOfOptions +
                    '].Description" type="text" value="" />' +
                    '<label for="OptionCounter" style="display: none;">' +
                    numberOfOptions +
                    '</label>' +
                    '<a href="" class="removeMCOption btn btn-danger">Verwijderen</a>' +
                    '</div> ');
                return false;
            });

        $("body").on("click",
            ".removeMCOption",
            function (e) {
                e.preventDefault();
                var wrapper = $(this).parent().parent().parent().children()[0];
                $(this).parent('div').remove();
                var options = $(wrapper).children(".MCOption");
                var i;
                var q;
                for (i = 0; i < options.length; i++) {
                    var children = options[i].children;
                    var oldNumber = children[4].innerHTML;
                    children[4].innerHTML = i;
                    for (q = 0; q < children.length; q++) {
                        var child = children[q];
                        switch (child.tagName) {
                            case "INPUT":
                                child.id = child.id.replace("Options_" + oldNumber, "Options_" + i);
                                child.name = child.name.replace("Options[" + oldNumber + "]", "PagesList[" + i + "]");
                                break;
                            default:
                                break;
                        }
                    }
                }
                return false;
            });

    });


    </script>
</body>
</html>
